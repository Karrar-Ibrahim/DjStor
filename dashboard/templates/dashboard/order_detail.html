{% extends 'base.html' %}
{% load humanize %}
{% load custom_filters %}

{% block title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #{{ order.id }}{% endblock %}

{% block content %}
<style>
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© */
    .invoice-card {
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e0e0e0;
    }
    .invoice-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #eee;
        padding: 20px;
    }
    .invoice-footer {
        background-color: #f8f9fa;
        padding: 20px;
    }
    .status-card {
        border-radius: 12px;
        background: #fff;
        border: 1px solid #e0e0e0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø§Ù„Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹) --- */
    @media print {
        /* Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„ØµÙØ­Ø© */
        body * {
            visibility: hidden;
        }
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù†Ø§ÙØ¨Ø§Ø± ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .no-print, nav, header, footer, .btn {
            display: none !important;
        }
        
        /* Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙ‚Ø· */
        #printable-invoice, #printable-invoice * {
            visibility: visible;
        }
        
        /* Ø¶Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„ØªÙ…Ù„Ø£ Ø§Ù„ÙˆØ±Ù‚Ø© */
        #printable-invoice {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 20px;
            border: none;
            box-shadow: none;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
        .bg-light, .invoice-header, .invoice-footer {
            background-color: #fff !important; /* ØªÙˆÙÙŠØ± Ø§Ù„Ø­Ø¨Ø± */
            border: 1px solid #ddd !important;
        }
        .text-primary, .text-success, .text-danger {
            color: black !important; /* Ø·Ø¨Ø§Ø¹Ø© Ø³ÙˆØ¯Ø§Ø¡ ÙˆØ§Ø¶Ø­Ø© */
        }
    }
</style>

<div class="container py-5">
    
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ù„Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <div>
            <h2 class="fw-bold mb-1">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨ #{{ order.id }}</h2>
            <p class="text-muted">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨: {{ order.created_at|date:"Y-m-d H:i A" }}</p>
        </div>
        <div class="d-flex gap-2">
            <button onclick="window.print()" class="btn btn-dark">
                <i class="bi bi-printer-fill"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„
            </button>
            <a href="{% url 'dashboard_orders' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-right"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
        <div class="col-lg-8">
            <div class="card invoice-card shadow-sm mb-4" id="printable-invoice">
                
                <!-- ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
                <div class="invoice-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="fw-bold text-primary mb-1"><i class="bi bi-cpu-fill"></i> Ø¹Ø´ØªØ§Ø± Ø³ØªÙˆØ±</h4>
                        <small class="text-muted">ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø©</small>
                    </div>
                    <div class="text-end">
                        <h5 class="fw-bold mb-0">ÙØ§ØªÙˆØ±Ø© #{{ order.id }}</h5>
                        <small class="text-muted">{{ order.created_at|date:"d/m/Y" }}</small>
                    </div>
                </div>

                <div class="card-body p-4">
                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
                    <div class="row mb-4">
                        <div class="col-6">
                            <h6 class="fw-bold text-uppercase text-muted small">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</h6>
                            <p class="mb-1 fw-bold">{{ order.full_name }}</p>
                            <p class="mb-1">{{ order.phone }}</p>
                            <p class="mb-0 text-muted small">{{ order.address }}</p>
                        </div>
                        <div class="col-6 text-end">
                            <h6 class="fw-bold text-uppercase text-muted small">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h6>
                            {% if order.status == 'pending' %}
                            <span class="badge bg-warning text-dark px-3 py-2">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>
                            {% elif order.status == 'completed' %}
                            <span class="badge bg-success px-3 py-2">Ù…ÙƒØªÙ…Ù„</span>
                            {% else %}
                            <span class="badge bg-danger px-3 py-2">Ù…Ù„ØºÙŠ</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="text-center">Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th class="text-center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items.all %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <span class="fw-bold">{{ item.product.name }}</span>
                                    </td>
                                    <td class="text-center">{{ item.price|currency }}</td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-end fw-bold">{{ item.get_cost|currency }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Footer) -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹) -->
                            <div class="p-3 bg-light rounded border border-dashed">
                                <small class="fw-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</small><br>
                                <small class="text-muted">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ³ÙˆÙ‚ÙƒÙ… Ù…Ø¹Ù†Ø§. ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ù…Ø´ÙƒÙ„Ø© ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td class="text-end">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</td>
                                        <!-- Ù…Ø¹Ø§Ø¯Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØµØ§ÙÙŠ -->
                                        <td class="text-end fw-bold">{{ order.total_amount|add:order.discount_amount|subtract:order.delivery_fee|currency }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-end">ÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„:</td>
                                        <td class="text-end text-danger">{{ order.delivery_fee|currency }}</td>
                                    </tr>
                                    {% if order.discount_amount > 0 %}
                                    <tr>
                                        <td class="text-end">Ø®ØµÙ… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ({{ order.coupon.code|default:"--" }}):</td>
                                        <td class="text-end text-success">- {{ order.discount_amount|currency }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr class="border-top">
                                        <td class="text-end pt-3 fs-5 fw-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</td>
                                        <td class="text-end pt-3 fs-5 fw-bold text-primary">{{ order.total_amount|currency }} Ø¯.Ø¹</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
                <div class="invoice-footer text-center text-muted small">
                    <p class="mb-0">ØªÙ… Ø¥ØµØ¯Ø§Ø± Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø¹Ø´ØªØ§Ø± Ø³ØªÙˆØ±</p>
                    <p class="mb-0">www.techstore-iq.com | 07700000000</p>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„ØªØ­ÙƒÙ… (Ù„Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
        <div class="col-lg-4 no-print">
            
            <!-- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© -->
            <div class="status-card p-4 mb-4">
                <h5 class="fw-bold mb-3">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h5>
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label text-muted small">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                        <select name="status" class="form-select form-select-lg">
                            <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ğŸŸ </option>
                            <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>Ù…ÙƒØªÙ…Ù„ (ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…) ğŸŸ¢</option>
                            <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Ù…Ù„ØºÙŠ ğŸ”´</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                </form>
            </div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
            <div class="status-card p-4">
                <h6 class="fw-bold border-bottom pb-2 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h6>
                <ul class="list-unstyled mb-0">
                    <li class="mb-2 d-flex justify-content-between">
                        <span class="text-muted">Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
                        <span>
                            {% if order.user %}
                            <span class="badge bg-info text-dark">Ù…Ø³Ø¬Ù„</span>
                            {% else %}
                            <span class="badge bg-secondary">Ø²Ø§Ø¦Ø±</span>
                            {% endif %}
                        </span>
                    </li>
                    <li class="mb-2 d-flex justify-content-between">
                        <span class="text-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯:</span>
                        <span>{{ order.items.count }}</span>
                    </li>
                    <li class="d-flex justify-content-between">
                        <span class="text-muted">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span>
                        <span>Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span>
                    </li>
                </ul>
            </div>

        </div>
    </div>
</div>
{% endblock %}